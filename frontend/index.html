<!DOCTYPE html>
<html lang = "en" >
<head>
    <meta charset="UTF-8">
    <title>3 Player Drawing</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

    <style>
        #gameScreen {
          display: none;
        }
        #default {
          width: 50px;
          height: 50px;
          background-color:#666666;
          stroke-width:6;
          stroke:black;
          border-radius: 10px;
          margin: 15px;
        }
        #green {
          width: 50px;
          height: 50px;
          background-color:#00ff99;
          stroke-width:6;
          stroke:black;
          border-radius: 10px;
          margin: 15px;
        }
        #blue {
          width: 50px;
          height: 50px;
          background-color:#00ffff;
          stroke-width:6;
          stroke:black;
          border-radius: 10px;
          margin: 15px;
        }
        #red {
          width: 50px;
          height: 50px;
          background-color:#ff0000;
          stroke-width:6;
          stroke:black;
          border-radius: 10px;
          margin: 15px;
        }
        #brown {
          width: 50px;
          height: 50px;
          background-color:#663300;
          stroke-width:6;
          stroke:black;
          border-radius: 10px;
          margin: 15px;
        }
      </style>
</head>
<body>
    <section class="vh-100">
        <div class="container h-100">
            <div id="initialScreen" class="h-100">
                <div class="d-flex flex-column align-items-center justify-content-center h-100">
                    <h1>Drawing Game!!</h1>
                    <button
                      type="submit"
                      class="btn btn-success"
                      id="newGameButton"
                    >
                      Create New Game
                    </button>
                    <div>OR</div>
                    <div class="form-group">
                      <input type="text" placeholder="Enter Game Code" id="gameCodeInput"/>
                    </div>
                    <button
                      type="submit"
                      class="btn btn-success"
                      id="joinGameButton"
                    >
                      Join Game
                    </button>
                </div>
              </div>
            
            <div id="gameScreen" class="h-100">
                <div class="d-flex flex-column align-items-center justify-content-center h-100">
        
                  <h1>Your game code is: <span id="gameCodeDisplay"></span></h1>
                  <h1>You are drawing: <span id="gameInstructions"></span>.</h1>
                  <h5>Make sure to connect your drawing to the red guides.</h5>
                  
                  <canvas id="canvas"></canvas>

                  
                  <div>
                    <button id="default"></button>
                    <button id="green" ></button>
                    <button id="blue"></button>
                    <button id="red"></button>
                    <button id="brown"></button>
                  </div>
                </div>
              </div>
        </div>
    </section>

    <script src="socket.io/socket.io.js"></script>
    <script>

        const socket = io();

        socket.on('connect', () => {
            console.log(socket.id)
        })

        socket.on('paint', paintGame);
        socket.on('playerNumber', setPlayerNumber);
        socket.on('unknownGame', handleUnknownGame);
        socket.on('tooManyPlayers', handleTooManyPlayers);
        socket.on('gameOver', handleGameOver);
        socket.on('gameCode', handleGameCode);
        socket.on('gameInstructions', handleGameInstructions);

        const BG_COLOUR = '#f7f0f0';
        const DRAWING_COLOUR = '#666666';
        const GUIDE_COLOUR = '#f21111'
        const PIXEL_DENSITY = 10;

        let dragging = false;
        let gameActive = false;
        let canvas, ctx;
        let playerNumber;
        let currentColour = DRAWING_COLOUR;
        let previousPixel = {
          x: 0, y: 0, start: true, colour:currentColour
        }

        const gameScreen = document.getElementById('gameScreen');
        const initialScreen = document.getElementById('initialScreen');
        const newGameBtn = document.getElementById('newGameButton');
        const joinGameBtn = document.getElementById('joinGameButton');
        const gameCodeInput = document.getElementById('gameCodeInput');
        const gameCodeDisplay = document.getElementById('gameCodeDisplay');
        const gameInstructions = document.getElementById('gameInstructions');
        const defaultButton = document.getElementById('default');
        const greenButton = document.getElementById('green');
        const blueButton = document.getElementById('blue');
        const redButton = document.getElementById('red');
        const brownButton = document.getElementById('brown');

        defaultButton.addEventListener('click', () => {
            currentColour = '#666666';
        });

        greenButton.addEventListener('click', () => {
          currentColour = '#00ff99';
        });

        blueButton.addEventListener('click', () => {
          currentColour = '#00ffff';
        });

        redButton.addEventListener('click', () => {
            currentColour = '#ff0000';
        });

        brownButton.addEventListener('click', () => {
            currentColour = '#663300';
        });

        newGameBtn.addEventListener('click', () => {
          socket.emit('newGame');
          init();
        });

        joinGameBtn.addEventListener('click', () => {
          console.log('joining' + gameCodeInput.value)
          socket.emit('joinGame', gameCodeInput.value);
          init();
        });


        function setPlayerNumber(number) {
          playerNumber = number;
        }

        function handleGameCode(gameCode) {
          console.log(gameCode);
          gameCodeDisplay.innerText = gameCode;
        }

        function init() {
          initialScreen.style.display = 'none';
          gameScreen.style.display = "block";


          canvas = document.getElementById('canvas');
          ctx = canvas.getContext('2d');

          canvas.width = 600;
          canvas.height = 300;

          ctx.fillStyle = BG_COLOUR;
          ctx.fillRect(0, 0, canvas.width, canvas.height);

          gameActive = true;

          document.addEventListener('mousedown', mousedown);
          document.addEventListener('mouseup', mouseup);
          document.addEventListener('mousemove', drag);
        }

        function mousedown() {
          dragging = true;
        }

        function mouseup() {
          dragging = false;
          previousPixel.start = true;
        }

        function drag(data) {
          if (dragging === true && gameActive === true) {

            let paintData = {
              x: data.offsetX,
              y: data.offsetY,
              colour: currentColour,
            }

            fillInPrevPixels(paintData.x, paintData.y, previousPixel.x, previousPixel.y, previousPixel.start, currentColour);

            
            previousPixel.x = paintData.x;
            previousPixel.y = paintData.y;
            previousPixel.colour = paintData.colour;


            ctx.fillStyle = currentColour;
            ctx.fillRect(paintData.x, paintData.y, 5, 5);

            socket.emit('drag', paintData);

          }
        }


        function fillInPrevPixels(currPixelX, currPixelY, prevPixelX, prevPixelY, start, currColour) {
          if (start === false) {
            Xlength = currPixelX - prevPixelX;
            Ylength = currPixelY - prevPixelY;
            Xdelta = (Xlength / PIXEL_DENSITY);
            Ydelta = (Ylength / PIXEL_DENSITY);
            console.log(Xdelta);console.log(Ydelta);
            for (let i = 0; i < PIXEL_DENSITY; i++) {
              currPixelX += Xdelta; 
              currPixelY += Ydelta;
              ctx.fillStyle = currColour;
              ctx.fillRect(currPixelX, currPixelY, 5, 5);
              socket.emit('drag', {x:currPixelX, y:currPixelY, colour: currColour});
            }
          } else {
            previousPixel.start = false;
          }
        }


        function handleGameInstructions(instructions) {
          gameInstructions.innerText = instructions;
          if(instructions === "head") {
            ctx.fillStyle = GUIDE_COLOUR;
            ctx.fillRect(275, 290, 5, 10);
            ctx.fillRect(325, 290, 5, 10);
          }else if(instructions === "legs") {
            ctx.fillStyle = GUIDE_COLOUR;
            ctx.fillRect(275, 0, 5, 10);
            ctx.fillRect(325, 0, 5, 10);
          }
        }

        function click(e) {
          //console.log(e);
          ctx.fillStyle = DRAWING_COLOUR;
          ctx.fillRect(e.x, e.y, 5, 5);
          //socket.emit('drag', e);
        }

        function paintGame(player) {

          player.paint.forEach(cell => {
            ctx.fillStyle = cell.colour;
            ctx.fillRect(cell.x, cell.y, 5, 5);
          });

        }

        function handleUnknownGame() {
          reset();
          alert("Unknown game code");
        }

        function handleTooManyPlayers() {
          alert("This game is already in progress");
        }

        function reset() {
          playerNumber = null;
          gameCodeInput.value = "";
          gameCodeDisplay.innerText = "";
          initialScreen.style.display = "block";
          gameScreen.style.display = "none";
        }

        function handleGameOver(state) {
          console.log(state);
          gameInstructions.innerText = "nothing! (you're done)";

          canvas.height = 600;

          ctx.fillStyle = BG_COLOUR;
          ctx.fillRect(0, 0, canvas.width, canvas.height);

          paintGame(state.players[0]);
          paintGame(state.players[1]);
          gameActive = false;
        }
    </script>
</body>
</html>