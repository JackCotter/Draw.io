<!DOCTYPE html>
<html lang = "en" >
<head>
    <meta charset="UTF-8">
    <title>3 Player Drawing</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

    <style>
        #gameScreen {
          display: none;
        }
      </style>
</head>
<body>
    <section class="vh-100">
        <div class="container h-100">
            <div id="initialScreen" class="h-100">
                <div class="d-flex flex-column align-items-center justify-content-center h-100">
                    <h1>Drawing Game!!</h1>
                    <button
                      type="submit"
                      class="btn btn-success"
                      id="newGameButton"
                    >
                      Create New Game
                    </button>
                    <div>OR</div>
                    <div class="form-group">
                      <input type="text" placeholder="Enter Game Code" id="gameCodeInput"/>
                    </div>
                    <button
                      type="submit"
                      class="btn btn-success"
                      id="joinGameButton"
                    >
                      Join Game
                    </button>
                </div>
              </div>
            
            <div id="gameScreen" class="h-100">
                <div class="d-flex flex-column align-items-center justify-content-center h-100">
        
                  <h1>Your game code is: <span id="gameCodeDisplay"></span></h1>
        
                  <canvas id="canvas"></canvas>
                </div>
              </div>
        </div>
    </section>

    <script src="socket.io/socket.io.js"></script>
    <script>

        const socket = io();

        socket.on('connect', () => {
            console.log(socket.id)
        })

        socket.on('paint', paintGame);
        socket.on('playerNumber', setPlayerNumber);
        socket.on('unknownGame', handleUnknownGame);
        socket.on('tooManyPlayers', handleTooManyPlayers);
        socket.on('gameOver', handleGameOver);
        socket.on('gameCode', handleGameCode);

        const BG_COLOUR = '#231f20';
        const DRAWING_COLOUR = '#666666';
        const PIXEL_DENSITY = 10;

        let dragging = false;
        let gameActive = false;
        let canvas, ctx;
        let playerNumber;
        let previousPixel = {
          x: 0, y: 0, start: true
        }

        const gameScreen = document.getElementById('gameScreen');
        const initialScreen = document.getElementById('initialScreen');
        const newGameBtn = document.getElementById('newGameButton');
        const joinGameBtn = document.getElementById('joinGameButton');
        const gameCodeInput = document.getElementById('gameCodeInput');
        const gameCodeDisplay = document.getElementById('gameCodeDisplay');

        newGameBtn.addEventListener('click', () => {
          socket.emit('newGame');
          init();
        });

        joinGameBtn.addEventListener('click', () => {
          console.log('joining' + gameCodeInput.value)
          socket.emit('joinGame', gameCodeInput.value);
          init();
        });


        function setPlayerNumber(number) {
          playerNumber = number;
        }

        function handleGameCode(gameCode) {
          console.log(gameCode);
          gameCodeDisplay.innerText = gameCode;
        }

        function init() {
          initialScreen.style.display = 'none';
          gameScreen.style.display = "block";


          canvas = document.getElementById('canvas');
          ctx = canvas.getContext('2d');

          canvas.width = canvas.height = 600;

          ctx.fillStyle = BG_COLOUR;
          ctx.fillRect(0, 0, canvas.width, canvas.height);

          gameActive = true;

          document.addEventListener('keydown', keydown);
          document.addEventListener('mousedown', mousedown);
          document.addEventListener('mouseup', mouseup);
          document.addEventListener('mousemove', drag);
        }

        function mousedown() {
          dragging = true;
        }

        function mouseup() {
          dragging = false;
        }

        function drag(data) {
          if (dragging === true && gameActive === true) {

            let paintData = {
              x: data.offsetX,
              y: data.offsetY,
              colour: DRAWING_COLOUR,
            }

            //fillInPrevPixels(paintData, previousPixel);

            previousPixel.x = paintData.x;
            previousPixel.y = paintData.y;

            ctx.fillStyle = DRAWING_COLOUR;
            ctx.fillRect(paintData.x, paintData.y, 5, 5);

            socket.emit('drag', paintData);

          }
        }


        function fillInPrevPixels(currPixel, prevPixel) {
          if (prevPixel.start === false) {
            Xlength = currPixel.x - prevPixel.x;
            Ylength = currPixel.y - prevPixel.y;
            Xdelta = Math.ceil(Xlength / PIXEL_DENSITY);
            Ydelta = Math.ceil(Ylength / PIXEL_DENSITY);
            console.log(Xdelta);console.log(Ydelta);
            for (let i = 0; i < PIXEL_DENSITY; i++) {
              currPixel.x += Xdelta; 
              currPixel.y += Ydelta;
              ctx.fillStyle = '#111111';
              ctx.fillRect(currPixel.x, currPixel.y, 5, 5);
              socket.emit('drag', currPixel);
            }
          } else {
            prevPixel.start = false;
            prevPixel.x = currPixel.x;
            prevPixel.y = currPixel.y;
          }
        }

        function keydown(e) {
          socket.emit('keydown', e.keyCode);

        }

        function click(e) {
          //console.log(e);
          ctx.fillStyle = DRAWING_COLOUR;
          ctx.fillRect(e.x, e.y, 5, 5);
          //socket.emit('drag', e);
        }

        function paintGame(player) {

          player.paint.forEach(cell => {
            ctx.fillStyle = cell.colour;
            ctx.fillRect(cell.x, cell.y, 5, 5);
          });

        }

        function handleUnknownGame() {
          reset();
          alert("Unknown game code");
        }

        function handleTooManyPlayers() {
          alert("This game is already in progress");
        }

        function reset() {
          playerNumber = null;
          gameCodeInput.value = "";
          gameCodeDisplay.innerText = "";
          initialScreen.style.display = "block";
          gameScreen.style.display = "none";
        }

        function handleGameOver(state) {
          console.log(state);

          canvas.height = 1200;

          ctx.fillStyle = BG_COLOUR;
          ctx.fillRect(0, 0, canvas.width, canvas.height);

          paintGame(state.players[0]);
          paintGame(state.players[1]);
          gameActive = false;
        }
    </script>
</body>
</html>